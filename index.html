<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>Surnames</title>

<link href="bienes-raices_2017/surnames_files/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="bienes-raices_2017/surnames_files/pagedtable-1.1/js/pagedtable.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="bienes-raices_2017/surnames_files/navigation-1.1/tabsets.js"></script>
<style type="text/css">
pre:not([class]) {
  background-color: white;
}
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceLine, a.sourceLine { display: inline-block; min-height: 1.25em; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; }
@media print {
code.sourceCode { white-space: pre-wrap; }
div.sourceLine, a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource div.sourceLine, .numberSource a.sourceLine
  { position: relative; }
pre.numberSource div.sourceLine::before, .numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em; }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
pre, code { color: #cccccc; background-color: #303030; }
@media screen {
a.sourceLine::before { text-decoration: underline; color: initial; }
}
code span.kw { color: #f0dfaf; } /* Keyword */
code span.dt { color: #dfdfbf; } /* DataType */
code span.dv { color: #dcdccc; } /* DecVal */
code span.bn { color: #dca3a3; } /* BaseN */
code span.fl { color: #c0bed1; } /* Float */
code span.ch { color: #dca3a3; } /* Char */
code span.st { color: #cc9393; } /* String */
code span.co { color: #7f9f7f; } /* Comment */
code span.ot { color: #efef8f; } /* Other */
code span.al { color: #ffcfaf; } /* Alert */
code span.fu { color: #efef8f; } /* Function */
code span.er { color: #c3bf9f; } /* Error */
code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */
code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
code span.sc { color: #dca3a3; } /* SpecialChar */
code span.vs { color: #cc9393; } /* VerbatimString */
code span.ss { color: #cc9393; } /* SpecialString */
code span.im { } /* Import */
code span.va { } /* Variable */
code span.cf { color: #f0dfaf; } /* ControlFlow */
code span.op { color: #f0efd0; } /* Operator */
code span.bu { } /* BuiltIn */
code span.ex { } /* Extension */
code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
code span.at { } /* Attribute */
code span.do { color: #7f9f7f; } /* Documentation */
code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
</style>



<link rel="stylesheet" href="bienes-raices_2017/surnames.css" />

</head>

<body>


<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>

<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>


<h1 class="title toc-ignore">Surnames</h1>



<p>We’d like to study the genealogy of the agropastoralist communities in the Coquimbo region (Chile) and see to what extent the evolution of the different wealth inheritance and land tenure norms in these communities can be explained by their genealogy.</p>
<section id="downloading-the-files-with-the-data" class="level2">
<h2>Downloading the files with the data</h2>
<p>The website of the <a href="http://www.comunidadesagricolas.cl/">Oficina Tecnica de Comunidades Agricolas</a> (OTCA) hosts the registry of commoners for all Agricultural Communities in the Coquimbo and Atacama regions (Chile). The OTCA collected the registry of commoners of some of the Agricultural Communities in years 2008, 2009, 2010, and 2011. For this reason, a community can have its registry of commoners available as a pdf file on the website for some, all or none of those years. We crawl the website to compile a list of the communities for which there is data together with the years from which their data is available and the url of their latest pdf file. This is done by the <code>download_pdfs</code> function in <code>download-pdfs.R</code>, which then proceeds to download the pdf files in a <code>pdfs</code> folder that it creates.</p>
<pre class="sourceCode r" id="cb1"><code class="sourceCode r"><div class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">source</span>(<span class="st">&#39;download-pdfs.R&#39;</span>)</div>
<div class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">download_pdfs</span>()</div></code></pre>
</section>
<section id="extracting-the-data" class="level2">
<h2>Extracting the data</h2>
<p>After downloading the files, we want to extract the tables contained in them as dataframes.</p>
<pre class="sourceCode r" id="cb2"><code class="sourceCode r"><div class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">source</span>(<span class="st">&#39;extract-pdfs.R&#39;</span>)</div>
<div class="sourceLine" id="cb2-2" data-line-number="2">commoners_untidy &lt;-<span class="st"> </span><span class="kw">read_pdfs</span>()</div></code></pre>
<p>This function tries to read the pdf file using several different methods in sequence and accepts the first method that returns a valid dataframe. The sequence of methods is determined by the <code>method</code> parameter, which in its default value dictates the following order:</p>
<ol type="1">
<li><a href="https://github.com/ropensci/tabulizer">tabulizer</a></li>
<li><a href="https://github.com/tabulapdf/tabula-java/">tabula</a></li>
<li>pdftohtml (not implemented yet)</li>
<li>pdftotext (not implemented yet)</li>
</ol>
<p>This is needed because no method so far is infallible. <!-- For the purpose of this function, --> In the context of this function, a valid dataframe is an object for which <code>is.data.frame()</code> returns <code>TRUE</code>, contains 5 columns, is not empty, and the commoner ids (second column) start from 1 and increase by 0, 1, or 2 with each row.</p>
<p>Unfortunately, many pdf files do not return a valid dataframe with any method. This is either because a) two columns are too close together and so are detected as one, or because b) the last column didn’t fit in a portrait page and so appears in the last pages. The latter was solved by transcribing the pdf files into csvs by hand or, in some lucky cases where the last column is trivial, by adding the last column to the 4-column extracted matrix. The former, on the other hand, can be solved programmatically by a1) separating the commoner number from the name when the second and third columns were merged (see function <code>format_table</code> of <code>extract-pdfs.R</code>), and by a2) separating the first name from the surname when the third and fourth columns were merged (see function <code>fix_names</code>). To make (a2) possible, compound names had to be merged into one word by substituting an underscore for the space, e.g. Del Rosario into Del_Rosario (see function <code>fix_compound_names</code>). <!-- The former can be solved by programmatic means --> <!-- (see for instance the code in --> <!--  function `format_table` of `extract-pdfs.R`, --> <!--  although more is needed to fully solve the first issue) --> <!-- but the latter must be solved --> <!-- by transcribing the pdf files into csvs by hand. --></p>
<p>The dataframes so extracted have several other issues as well. They are presented in the following table together with the function that solves each issue.</p>
<table style="width:92%;">
<colgroup>
<col style="width: 66%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Issue</th>
<th style="text-align: center;">Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">The same name appears with and without diacritic marks.</td>
<td style="text-align: center;"><code>remove_accents</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">Commoners that were removed from the registry sometimes appear as a commoner with name “eliminado” (Spanish for “removed”).</td>
<td style="text-align: center;"><code>remove_nonpeople</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Sometimes a company or community owns a right in a community but they can’t be subject to the surname analysis we will perform.</td>
<td style="text-align: center;"><code>remove_nonpeople</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">Sometimes only the initial of a name or surname appears.</td>
<td style="text-align: center;"><code>remove_initials</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Successions were sometimes annotated as a ficticious extra commoner before the list of commoners in the succession.</td>
<td style="text-align: center;"><code>remove_sucesiones</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">Only the first commoner in a succession shows the rights of the whole succession next to it. This number had to be divided by all commoners in the succession.</td>
<td style="text-align: center;"><code>fix_rights</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Sometimes commoners appear more than once in a community when they own more than one right.</td>
<td style="text-align: center;"><code>fix_repeated</code></td>
</tr>
</tbody>
</table>
<p>Finally, some extra information was added to this dataframe to later be able to compute the gender bias (<code>assign_sex</code>) and do aggregated analyses per commune and province (<code>add_commune</code> and <code>add_province_and_region</code>). Also, in order to facilitate the surname analysis, the first surname (received from the father) and the second surname (received from the mother) were split.</p>
<p>All these functions and a few other case-by-case tweaks are run by the <code>extract_pdfs</code> function.</p>
<pre class="sourceCode r" id="cb3"><code class="sourceCode r"><div class="sourceLine" id="cb3-1" data-line-number="1">commoners &lt;-<span class="st"> </span><span class="kw">extract_pdfs</span>(commoners_untidy)</div></code></pre>
</section>
<section id="analysis" class="level2">
<h2>Analysis</h2>
<p>With the data we collected in the previous step we can now run some analyses. The first analysis we would like to see is a dendrogram (i.e. a tree) of the communities according to the similarity of their distribution of surnames.</p>
<p>There are different metrics of the similarity of surname distributions. One commonly used is Hedrick’s formula, which computes the similarity <span class="math inline">\(H_{ij}\)</span> of a community <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> as:</p>
<p><span class="math display">\[ H_{ij} = \frac{ \sum_s s_i s_j }{
     \frac{1}{2} (\sum_s s_i^2 + \sum_s s_j^2) } \]</span></p>
<p>where <span class="math inline">\(s \in \mathbb{N}^C\)</span> is the vector containing the frecuencies <span class="math inline">\(s_i\)</span> of a given surname in community <span class="math inline">\(i \in C\)</span>. Dually, one can see a community as a surname-indexed vector <span class="math inline">\(i \in \mathbb{N}^S\)</span> with elements <span class="math inline">\(i_s = s_i\)</span>. We can then rewrite <span class="math inline">\(H_{ij}\)</span> as</p>
<p><span class="math display">\[ H_{ij} = \frac{ 2 \, (i \cdot j) }{
     i \cdot i + j \cdot j } \]</span></p>
<p>where <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are surname-indexed vectors as above and <span class="math inline">\(i \cdot j\)</span> is their dot product. Note that <span class="math inline">\(0 \leq H_{ij} \leq 1\)</span> because <span class="math inline">\(\newcommand{\norm}[1]{\left\lVert #1 \right\rVert}\)</span></p>
<ol type="1">
<li><span class="math inline">\(i \cdot i = \norm{i}^2\)</span> and <span class="math inline">\(j \cdot j = \norm{j}^2\)</span> are both nonnegative;</li>
<li>all coordinates of <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are nonnegative, so the angle between them can be at most <span class="math inline">\(90^\circ\)</span> and <span class="math inline">\(i \cdot j\)</span> is nonnegative; and</li>
<li>the maximum value for <span class="math inline">\(i \cdot j\)</span> is obtained when <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are co-linear, in which case <span class="math inline">\(i \cdot j = \norm{i} \norm{j}\)</span> and <span class="math inline">\(2 \norm{i} \norm{j} \leq \norm{i}^2 + \norm{j}^2\)</span>.</li>
</ol>
<p>One then obtains a metric <span class="math inline">\(G_{ij} = 1 - H_{ij}\)</span> on <span class="math inline">\(\mathbb{N}^S\)</span>.</p>
<ol type="1">
<li>non-negativity: <span class="math inline">\(G_{ij} \geq 0\)</span> since <span class="math inline">\(H_{ij} \leq 1\)</span></li>
<li>identity of indiscernibles: <span class="math inline">\(G_{ij} = 0\)</span> iff <span class="math inline">\(i = j\)</span> because <span class="math inline">\(H_{ij} = 1\)</span> only when <span class="math inline">\(2 \norm{i} \norm{j} = \norm{i}^2 + \norm{j}^2\)</span></li>
<li>symmetry: <span class="math inline">\(G_{ij} = G_{ji}\)</span> as the definition of <span class="math inline">\(H_{ij}\)</span> is symmetric</li>
<li>triangle inequality: <span class="math inline">\(G_{ik} \leq G_{ij} + G_{jk}\)</span></li>
</ol>
<p>TODO: prove triangle inequality.</p>
<p>As a metric on the non-normalised vectors, <span class="math inline">\(G_{ij}\)</span> has the property that if <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are co-linear but not of the same magnitude, then <span class="math inline">\(G_{ij}\)</span> is strictly greater than 0. In other words, two communities with the same relative composition (ie probability distribution) of surnames but different number of commoners will have <span class="math inline">\(H_{ij} &lt; 1\)</span> and thus <span class="math inline">\(G_{ij} &gt; 0\)</span>. This scale dependence is unfortunate. Instead we would like to have a scale-independent metric. An interesting scale-independent pseudometric is <span class="math inline">\(1\)</span> minus the cosine of the angle <span class="math inline">\(\theta\)</span> between vectors <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> in the euclidean space <span class="math inline">\(\mathbb{R}^S\)</span>.</p>
<p><span class="math display">\[ D_{ij} = 1 - \cos \theta = 1 - \frac{ i \cdot j }{
     \sqrt{i \cdot i} \sqrt{j \cdot j} } =
   1 - \frac{ i \cdot j }{ \norm{i} \norm{j} } \]</span></p>
<p>Despite the similarities between <span class="math inline">\(D_{ij}\)</span> and <span class="math inline">\(H_{ij}\)</span>, <span class="math inline">\(D_{ij}\)</span> is equal to <span class="math inline">\(1\)</span> whenever <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> have the same relative composition of surnames. This implies that <span class="math inline">\(D_{ij}\)</span> is not a metric on <span class="math inline">\(\mathbb{R}^S\)</span> but a metric on the normalised vectors <span class="math inline">\(i/\norm{i}\)</span>. As before, we have <span class="math inline">\(0 \leq D_{ij} \leq 1\)</span>.</p>
<p>Expressing <span class="math inline">\(i \cdot j\)</span> in terms of the cosine of <span class="math inline">\(\theta\)</span>, one can rewrite <span class="math inline">\(H_{ij}\)</span> yet again as</p>
<p><span class="math display">\[ H_{ij} = \frac{ 2 \, (i \cdot j) }{ \norm{i}^2 + \norm{j}^2 } =
   \frac{ 2 \cos \theta \norm{i} \norm{j} }{
   \norm{i}^2 + \norm{j}^2 } =
   \frac{ 2 \cos \theta }{ \frac{\norm{i}}{\norm{j}} +
   \frac{\norm{i}}{\norm{j}} } \]</span></p>
<p>Notice that whenever <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are normalised (ie <span class="math inline">\(\norm{i} = 1 = \norm{j}\)</span>) then <span class="math inline">\(H_{ij} = \cos \theta\)</span>. Interestingly, Hedrick’s similarity is usually computed on the normalised vectors. <!-- Still, I have no geometric intution --> <!-- for these expressions in the general case. --></p>
<p>The distance between two communities may also be computed by using any standard metric for probability distributions on the normalised vectors, eg <a href="https://en.wikipedia.org/wiki/Wasserstein_metric">Wasserstein</a>. For the Wasserstein metric see R package <a href="https://www.rdocumentation.org/packages/transport/versions/0.9-4">transport</a>.</p>
<p>From the distance matrix obtained using any of the methods above we would like to build a dendrogram. The simplest methods are hierarchical clustering methods, of which there are several varieties depending on the way in which distances between groups of communities are computed. The method can be summarised as follows:</p>
<ol type="1">
<li>put each element into its own group</li>
<li>the distance between such singleton groups is taken directly from the distance matrix</li>
<li>join the closest groups into a new group</li>
<li>compute the distance between the new group and the rest using a function that takes as input the distance vectors of each of the elements in the group</li>
</ol>
<p>It’d be nice to make a heatmap matrix indicating how similar two dendrograms computed with different distance and clustering methods are.</p>
<pre class="sourceCode r" id="cb4"><code class="sourceCode r"><div class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">source</span>(<span class="st">&#39;analysis.R&#39;</span>)</div></code></pre>
</section>

</div>

<script>
// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
